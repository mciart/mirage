name: Publish release / Test Build

on:
  release:
    types: [created]
  # [新增] 允许手动点击按钮触发测试打包
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Virtual version tag for testing (e.g. v0.0.1-test)'
        required: false
        default: 'v0.0.0-test'

jobs:
  # 注意：publish-crate 通常只在正式 release 时跑，这里加了条件
  publish-crate:
    name: Publish crate
    if: github.event_name == 'release' 
    runs-on: ubuntu-latest
    # ... (原有步骤保持不变) ...

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    container: quay.io/pypa/manylinux_2_28_x86_64
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build x86_64 Linux binaries
        run: |
          cargo build --release --workspace --features jemalloc
          mkdir -p release
          # [修正] 名称改为 mirage
          cp target/release/mirage-client release/
          cp target/release/mirage-server release/
          cp target/release/mirage-users release/
          cp target/release/mirage-client-gui release/
          # cp target/release/mirage-client-daemon release/ (如果有的话)
      - uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: release/

  package-linux:
    name: Package Linux
    runs-on: ubuntu-latest
    needs: build-linux
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          cache-targets: false
          cache-directories: ~/.cargo/bin
      - uses: actions/download-artifact@v4
        with:
          name: linux-binaries
          path: target/release/
      - name: Make binaries executable
        run: chmod +x target/release/*
      - name: Create tarball
        run: |
          mkdir -p release
          cp target/release/* release/
          # 使用 github.ref_name 或者是手动输入的 tag
          TAG_NAME="${{ github.event.inputs.version_tag || github.ref_name }}"
          tar zcf mirage-${TAG_NAME}-linux-x86_64.tar.gz -C release .
      - name: Install AppImage dependencies
        run: sudo apt-get update && sudo apt-get install -y libfuse2
      - name: Install cargo-packager
        run: cargo install cargo-packager --locked
      - name: Inject version into packager config
        run: |
          # 自动获取版本号逻辑保持不变
          VERSION=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.name=="mirage-gui") | .version')
          sed -i "s/version = \"0.0.0\"/version = \"$VERSION\"/" packager.linux.toml
      - name: Package Linux installers
        run: cargo packager --release -c packager.linux.toml
        env:
          SKIP_BUILD: "1"
      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          TAG_NAME="${{ github.event.inputs.version_tag || github.ref_name }}"
          # 移动打包好的文件
          mv mirage-*.tar.gz artifacts/ || true
          mv target/release/*.deb artifacts/mirage-${TAG_NAME}-linux-x86_64.deb || true
          mv target/release/*.AppImage artifacts/mirage-${TAG_NAME}-linux-x86_64.AppImage || true
      
      # [新增] 将安装包上传到 Actions 页面供测试下载
      - uses: actions/upload-artifact@v4
        name: Upload Test Packages
        with:
          name: linux-installers
          path: artifacts/

      # [修改] 只有是正式 Release 时才上传到 Release 页面
      - uses: softprops/action-gh-release@v1
        if: github.event_name == 'release'
        name: Add artifacts to release
        with:
          files: artifacts/*

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - uses: ilammy/setup-nasm@v1
      - name: Build x86_64 Windows binaries
        run: |
          cargo build --release --workspace
          mkdir ./release
          # [修正] 名称改为 mirage
          cp target/release/mirage-client.exe release/
          cp target/release/mirage-server.exe release/
          cp target/release/mirage-users.exe release/
          cp target/release/mirage-client-gui.exe release/
          # cp target/release/mirage-client-daemon.exe release/
      - uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: release/

  package-windows:
    name: Package Windows
    runs-on: windows-latest
    needs: build-windows
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          cache-targets: false
          cache-directories: ~/.cargo/bin
      - uses: actions/download-artifact@v4
        with:
          name: windows-binaries
          path: target/release/
      - name: Download wintun
        run: |
          Invoke-WebRequest https://www.wintun.net/builds/wintun-0.14.1.zip -OutFile $env:TEMP\wintun.zip
          Expand-Archive $env:TEMP\wintun.zip -DestinationPath $env:TEMP\wintun -Force
          cp $env:TEMP\wintun\wintun\bin\amd64\wintun.dll target/release/
      - name: Create zip archive
        run: |
          mkdir ./release
          cp target/release/* release/
          $TAG_NAME = "${{ github.event.inputs.version_tag }}"
          if ([string]::IsNullOrEmpty($TAG_NAME)) { $TAG_NAME = "${{ github.ref_name }}" }
          Compress-Archive -Path release/* -DestinationPath mirage-$TAG_NAME-windows-x86_64.zip
      - name: Install cargo-packager
        run: cargo install cargo-packager --locked
      - name: Inject version into packager config
        run: |
          # 这里的 name 需要改成 mirage-gui (请检查 Cargo.toml 里的包名)
          $VERSION = (cargo metadata --format-version 1 --no-deps | ConvertFrom-Json).packages | Where-Object { $_.name -eq "mirage-gui" } | Select-Object -ExpandProperty version
          (Get-Content packager.windows.toml) -replace 'version = "0.0.0"', "version = `"$VERSION`"" | Set-Content packager.windows.toml
      - name: Package Windows installer
        run: cargo packager --release -c packager.windows.toml
        env:
          SKIP_BUILD: "1"
          SKIP_WINTUN: "1"
      - name: Collect artifacts
        run: |
          mkdir artifacts
          $TAG_NAME = "${{ github.event.inputs.version_tag }}"
          if ([string]::IsNullOrEmpty($TAG_NAME)) { $TAG_NAME = "${{ github.ref_name }}" }
          
          Move-Item mirage-*-windows-x86_64.zip artifacts/
          # 移动生成的 setup.exe
          Move-Item target/release/*-setup.exe artifacts/mirage-$TAG_NAME-windows-x86_64-setup.exe

      # [新增] 上传 Windows 安装包供测试
      - uses: actions/upload-artifact@v4
        name: Upload Test Packages
        with:
          name: windows-installers
          path: artifacts/

      # [修改] 仅 Release 时发布
      - uses: softprops/action-gh-release@v1
        if: github.event_name == 'release'
        name: Add artifacts to release
        with:
          files: artifacts/*

  # (MacOS 部分同理修改：改名 mirage, 增加 upload-artifact, 给 release 步骤加 if 条件)
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build arm64 macOS binaries
        run: |
          cargo build --release --workspace --features jemalloc
          mkdir -p release
          # [修正] mirage
          cp target/release/mirage-client release/
          cp target/release/mirage-server release/
          cp target/release/mirage-users release/
          cp target/release/mirage-client-gui release/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: release/

  package-macos:
    name: Package macOS
    runs-on: macos-latest
    needs: build-macos
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          cache-targets: false
          cache-directories: ~/.cargo/bin
      - uses: actions/download-artifact@v4
        with:
          name: macos-binaries
          path: target/release/
      - name: Make binaries executable
        run: chmod +x target/release/*
      - name: Create tarball
        run: |
          mkdir -p release
          cp target/release/* release/
          TAG_NAME="${{ github.event.inputs.version_tag || github.ref_name }}"
          tar zcf mirage-${TAG_NAME}-macos-arm64.tar.gz -C release .
      - name: Install cargo-packager
        run: cargo install cargo-packager --locked
      - name: Inject version into packager config
        run: |
          VERSION=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.name=="mirage-gui") | .version')
          sed -i '' "s/version = \"0.0.0\"/version = \"$VERSION\"/" packager.macos.toml
      - name: Package macOS installer
        run: cargo packager --release -c packager.macos.toml
        env:
          SKIP_BUILD: "1"
      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          TAG_NAME="${{ github.event.inputs.version_tag || github.ref_name }}"
          mv mirage-*.tar.gz artifacts/
          mv target/release/*.dmg artifacts/mirage-${TAG_NAME}-macos-arm64.dmg

      # [新增] 上传 macOS 安装包
      - uses: actions/upload-artifact@v4
        name: Upload Test Packages
        with:
          name: macos-installers
          path: artifacts/

      # [修改]
      - uses: softprops/action-gh-release@v1
        if: github.event_name == 'release'
        name: Add artifacts to release
        with:
          files: artifacts/*